#must run under ANDROID_BUILD_TOP
/bin/bash -c "(make -j16 -C kernel KBUILD_RELSRC=../../../../../../kernel O=..//out/target/product/payton/obj/KERNEL_OBJ ARCH=arm64 CROSS_COMPILE=aarch64-linux-android- KBUILD_BUILD_USER= KBUILD_BUILD_HOST= KCFLAGS=-mno-android) && \
(out/host/linux-x86/bin/acp -fp out/target/product/payton/obj/KERNEL_OBJ/arch/arm64/boot/Image.gz-dtb out/target/product/payton/kernel) && \
(out/host/linux-x86/bin/mkbootimg  --kernel out/target/product/payton/kernel  --ramdisk out/target/product/payton/ramdisk-recovery.img --cmdline \"console=ttyMSM0,115200,n8 androidboot.console=ttyMSM0 earlycon=msm_serial_dm,0xc170000 androidboot.hardware=qcom user_debug=31 msm_rtb.filter=0x237 ehci-hcd.park=3 lpm_levels.sleep_disabled=1 sched_enable_hmp=1 sched_enable_power_aware=1 service_locator.enable=1 swiotlb=1 androidboot.configfs=true androidboot.usbcontroller=a800000.dwc3 androidboot.hab.csv=1 androidboot.hab.product=payton androidboot.hab.cid=50 buildvariant=userdebug veritykeyid=id:\`openssl x509 -in build/target/product/security/verity.x509.pem -text | grep keyid | sed 's/://g' | tr -d '[:space:]' | tr '[:upper:]' '[:lower:]' | sed 's/keyid//g'\`\" --base 0x00000000 --pagesize 4096 --os_version 7.1.1 --os_patch_level 2017-08-01  --output  out/target/product/payton/boot.img --id > out/target/product/payton/recovery.id ) && \
(out/host/linux-x86/bin/boot_signer /boot  out/target/product/payton/boot.img build/target/product/security/verity.pk8 build/target/product/security/verity.x509.pem  out/target/product/payton/boot.img ) && \
(size=\$(for i in  out/target/product/payton/boot.img; do stat --format \"%s\" \"\$i\" | tr -d '\\n'; echo +; done; echo 0); total=\$(( \$( echo \"\$size\" ) )); printname=\$(echo -n \" out/target/product/payton/boot.img\" | tr \" \" +); img_blocksize=135168; twoblocks=\$((img_blocksize * 2)); onepct=\$(((((69206016 / 100) - 1) / img_blocksize + 1) * img_blocksize)); reserve=\$((twoblocks > onepct ? twoblocks : onepct)); maxsize=\$((69206016 - reserve)); echo \"\$printname maxsize=\$maxsize blocksize=\$img_blocksize total=\$total reserve=\$reserve\"; if [ \"\$total\" -gt \"\$maxsize\" ]; then echo \"error: \$printname too large (\$total > [69206016 - \$reserve])\"; false; elif [ \"\$total\" -gt \$((maxsize - 32768)) ]; then echo \"WARNING: \$printname approaching size limit (\$total now; limit \$maxsize)\"; fi )" 
